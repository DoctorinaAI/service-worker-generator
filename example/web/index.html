<!DOCTYPE html>
<html>

<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Service Worker Example">
  <meta flt-viewport="" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="sw_example">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <title>Service Worker</title>
  <link rel="manifest" href="manifest.json">
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #764ba2;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #loading {
      text-align: center;
      color: white;
      max-width: 90vw;
      animation: fadeIn 0.6s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-container {
      position: relative;
      display: inline-block;
      margin-bottom: 2rem;
    }

    .logo-image {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .logo-image:hover {
      transform: scale(1.05);
    }

    .progress-ring {
      position: absolute;
      top: -10px;
      left: -10px;
      width: 140px;
      height: 140px;
      transform: rotate(-90deg);
    }

    .progress-ring-circle {
      fill: none;
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 4;
    }

    .progress-ring-progress {
      fill: none;
      stroke: #00ff88;
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 439.823;
      stroke-dashoffset: 439.823;
      transition: stroke-dashoffset 0.3s ease;
      filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.5));
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin: 0 0 1rem 0;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .progress-text {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-top: 1rem;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      color: #b0b0b0;
    }

    .progress-percentage {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-top: 0.5rem;
      font-weight: 400;
      color: #b0b0b0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      transition: color 0.3s ease;
    }

    .loading-dots {
      display: inline-block;
      margin-left: 5px;
    }

    .loading-dots::after {
      content: '';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    @media (prefers-color-scheme: dark) { }

    @media (max-width: 480px) {
      .logo-image {
        width: 100px;
        height: 100px;
      }

      .progress-ring {
        width: 120px;
        height: 120px;
        top: -10px;
        left: -10px;
      }

      h1 {
        font-size: 2rem;
      }

      .progress-text {
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <!-- Loading indicator -->
  <div id="loading">
    <div class="logo-container">
      <svg class="progress-ring" viewBox="0 0 140 140">
        <circle class="progress-ring-circle" cx="70" cy="70" r="65"></circle>
        <circle class="progress-ring-progress" cx="70" cy="70" r="65" id="progress-circle"></circle>
      </svg>
      <img src="icons/Icon-192.png" class="logo-image" alt="App Logo">
    </div>
    <h1>Service Worker</h1>
    <div class="progress-text" id="progress-text">Initializing<span class="loading-dots"></span></div>
    <div class="progress-percentage" id="progress-percentage">0%</div>
  </div>

  <!-- Flutter JS and build config -->
  <script>
    // This script tag is replaced by the Flutter build system
    {{flutter_js}}
    {{flutter_build_config}}

    // Progress management
    let currentProgress = 0;
    let isServiceWorkerAvailable = false;
    let totalResourcesSize = 0; // Total size from sw.js RESOURCES_SIZE
    let loadedResources = new Map(); // Track loaded resources: resourceKey -> { size, loaded }

    const progressCircle = document.getElementById('progress-circle');
    const progressText = document.getElementById('progress-text');
    const progressPercentage = document.getElementById('progress-percentage');
    const circumference = 2 * Math.PI * 65; // radius = 65

    // Initialize progress ring
    progressCircle.style.strokeDasharray = circumference;
    progressCircle.style.strokeDashoffset = circumference;

    /**
     * Calculates the total loaded resources size.
     * Returns the total loaded size from the loadedResources map.
     */
    function calculateTotalProgress() {
      let totalLoaded = 0;
      loadedResources.forEach(resource => {
        totalLoaded += resource.loaded;
      });
      return totalLoaded;
    }

    /**
     * Updates the progress ring and text.
     * @param {number} value - Progress value (0-100).
     * @param {string} text - Optional text to display.
     */
    function updateLoadingProgress(value, text = '') {
      currentProgress = Math.min(Math.max(value, 0), 100);

      // Update circular progress
      const offset = circumference - (currentProgress / 100) * circumference;
      progressCircle.style.strokeDashoffset = offset;

      // Update text
      progressPercentage.textContent = `${Math.round(currentProgress)}%`;
      if (text) progressText.innerHTML = `${text}<span class="loading-dots"></span>`;

      // Console logging
      console.log(`Loading progress: ${Math.round(currentProgress)}% - ${text || 'Loading'}`);
    }

    /**
     * Removes the loading widget with a fade-out effect.
     * This function is called when the app is ready.
     */
    function removeLoadingIndicator() {
      const loadingEl = document.getElementById("loading");
      if (loadingEl) {
        loadingEl.style.transition = 'opacity 0.5s ease-out';
        loadingEl.style.opacity = '0';
        setTimeout(() => loadingEl.remove(), 500);
      }
    }

    // Expose functions to the global scope for external access
    window.updateLoadingProgress = updateLoadingProgress;
    window.removeLoadingIndicator = removeLoadingIndicator;

    /**
     * Registers the service worker and listens for messages.
     * Updates progress based on service worker messages.
     */
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/flutter_service_worker.js');
          console.log('Service Worker registered successfully');
          isServiceWorkerAvailable = true; // Listen for service worker messages
          navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'sw-progress') {
              const { resourceKey, resourceSize, loaded, resourceUrl, resourcesSize, status } = event.data;

              totalResourcesSize = resourcesSize || totalResourcesSize; // Update total size if provided

              if (resourceKey && resourceSize !== undefined && loaded !== undefined) {
                // Update or add resource in our hash table
                loadedResources.set(resourceKey, {
                  size: resourceSize,
                  loaded: loaded,
                  url: resourceUrl,
                  status: status // installing | fetching
                });

                // Calculate total progress
                const totalLoaded = calculateTotalProgress();
                const progressPercent = Math.min((totalLoaded / totalResourcesSize) * 100, 100);

                // Map SW progress from 10% to 90% (leaving 10% for dart logic)
                const mappedProgress = 10 + (progressPercent * 0.8); // 10% + (0-100% * 80%)

                let progressText = 'Loading resources';
                if (totalLoaded > 0) {
                  const loadedMB = (totalLoaded / 1024 / 1024).toFixed(1);
                  const totalMB = (totalResourcesSize / 1024 / 1024).toFixed(1);
                  //const resourceCount = loadedResources.size;
                  progressText = `Loading resources (${loadedMB}/${totalMB} MB)`;
                }

                updateLoadingProgress(mappedProgress, progressText);
              }
            }
          });

          return registration;
        } catch (error) {
          console.warn('Service Worker registration failed:', error);
          isServiceWorkerAvailable = false;
          return null;
        }
      } else {
        console.warn('Service Workers are not supported');
        isServiceWorkerAvailable = false;
        return null;
      }
    }

    /**
     * Initializes the Flutter application.
     * Registers the service worker and loads the Flutter engine.
     */
    async function initializeApp() {
      // Register service worker first
      await registerServiceWorker();

      // Initial progress
      updateLoadingProgress(10, 'Loading application');

      const searchParams = new URLSearchParams(window.location.search);
      const renderer = searchParams.get('renderer');
      const userConfig = renderer ? { 'renderer': renderer } : {};

      try {
        await _flutter.loader.load({
          config: userConfig,
          onEntrypointLoaded: async function(engineInitializer) {
            if (!isServiceWorkerAvailable) {
              // Fallback progress without service worker
              updateLoadingProgress(30, 'Initializing Flutter engine');
            }

            const appRunner = await engineInitializer.initializeEngine();
            updateLoadingProgress(90, 'Starting application');
            await appRunner.runApp();
          }
        });
      } catch (error) {
        console.error('Failed to initialize Flutter app:', error);
        updateLoadingProgress(0, 'Failed to load application');
      }
    }

    // Event listeners
    window.addEventListener('load', function () {
      initializeApp();
    });

    // Listen for the first frame event to finalize loading
    window.addEventListener('flutter-first-frame', function () {
      updateLoadingProgress(100, 'Ready');

      // Fade out loading screen after a short delay
      setTimeout(() => {
        const loadingEl = document.getElementById("loading");
        if (loadingEl) {
          loadingEl.style.transition = 'opacity 0.5s ease-out';
          loadingEl.style.opacity = '0';
          setTimeout(() => loadingEl.remove(), 500);
        }
      }, 300);
    });

    // Handle service worker updates,
    // reloading the page when a new service worker takes control.
    //if ('serviceWorker' in navigator) {
    //  navigator.serviceWorker.addEventListener('controllerchange', () => {
    //    console.log('Service Worker updated, reloading page...');
    //    window.location.reload();
    //  });
    //}
  </script>
</body>
</html>